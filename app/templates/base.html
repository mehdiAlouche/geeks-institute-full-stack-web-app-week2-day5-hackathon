<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {% block head %}
      <title>{% block title %}School Management System{% endblock %}</title>
    {% endblock %}
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet" />
    
    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Custom Styles -->
    <style>
      body {
        font-family: "Poppins", sans-serif;
      }
      
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      
      .card-hover {
        transition: all 0.3s ease;
      }
      
      .card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      }
      
      .loading {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-gray-50 min-h-screen">
    <!-- Navigation -->
    <navbar-component></navbar-component>
    
    <!-- Flash Messages -->
    <div id="flash-messages" class="fixed top-20 right-4 z-50 space-y-2"></div>
    
    <!-- Main Content -->
    <main class="min-h-screen">
      {% block content %} {% endblock %}
    </main>
    
    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
      <div class="max-w-7xl mx-auto px-4 text-center">
        <p>&copy; 2024 School Management System. Built with Flask & Web Components.</p>
      </div>
    </footer>

    <!-- Web Components -->
    <script src="{{ url_for('static', filename='components/navbar-components.js') }}"></script>
    <script src="{{ url_for('static', filename='components/ui-components.js') }}"></script>
    <script src="{{ url_for('static', filename='components/course-components.js') }}"></script>
    <script src="{{ url_for('static', filename='components/user-components.js') }}"></script>
    <script src="{{ url_for('static', filename='components/comment-components.js') }}"></script>
    
    <!-- Global JavaScript -->
    <script>
      // Global utility functions
      window.SchoolApp = {
        // API Base URL
        apiBase: '/api',
        
        // Ready state
        ready: false,
        
        // Show flash messages
        showFlash: function(message, type = 'info') {
          const flashContainer = document.getElementById('flash-messages');
          const alertClass = {
            'success': 'bg-green-500',
            'error': 'bg-red-500',
            'warning': 'bg-yellow-500',
            'info': 'bg-blue-500'
          }[type] || 'bg-blue-500';
          
          const flashDiv = document.createElement('div');
          flashDiv.className = `${alertClass} text-white px-6 py-3 rounded-lg shadow-lg max-w-sm`;
          flashDiv.innerHTML = `
            <div class="flex items-center justify-between">
              <span>${message}</span>
              <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="bi bi-x-lg"></i>
              </button>
            </div>
          `;
          
          flashContainer.appendChild(flashDiv);
          
          // Auto remove after 5 seconds
          setTimeout(() => {
            if (flashDiv.parentElement) {
              flashDiv.remove();
            }
          }, 5000);
        },
        
        // Make API calls
        apiCall: async function(endpoint, options = {}) {
          const token = localStorage.getItem('auth_token');
          const defaultOptions = {
            headers: {
              'Content-Type': 'application/json',
              ...(token && { 'Authorization': `Bearer ${token}` })
            }
          };
          
          try {
            const response = await fetch(`${this.apiBase}${endpoint}`, {
              ...defaultOptions,
              ...options,
              headers: { ...defaultOptions.headers, ...options.headers }
            });
            
            const data = await response.json();
            
            if (!response.ok) {
              throw new Error(data.error || 'API request failed');
            }
            
            return data;
          } catch (error) {
            console.error('API Error:', error);
            this.showFlash(error.message, 'error');
            throw error;
          }
        },
        
        // Check if user is authenticated
        isAuthenticated: function() {
          return !!localStorage.getItem('auth_token');
        },
        
        // Get current user info
        getCurrentUser: function() {
          const userStr = localStorage.getItem('current_user');
          return userStr ? JSON.parse(userStr) : null;
        },
        
        // Login user
        login: function(token, user) {
          localStorage.setItem('auth_token', token);
          localStorage.setItem('current_user', JSON.stringify(user));
          
          // Set cookie for server-side authentication
          document.cookie = `auth_token=${token}; path=/; max-age=3600; SameSite=Lax`;
          
          this.showFlash('Login successful!', 'success');
          // Refresh navbar to show user info
          this.refreshNavbar();
        },
        
        // Logout user
        logout: function() {
          localStorage.removeItem('auth_token');
          localStorage.removeItem('current_user');
          
          // Clear cookie
          document.cookie = 'auth_token=; path=/; expires=Thu, 01 Jan 1970 00:00:00 GMT';
          
          this.showFlash('Logged out successfully', 'info');
          // Refresh navbar to hide user info
          this.refreshNavbar();
          window.location.href = '/';
        },
        
        // Refresh navbar component
        refreshNavbar: function() {
          const navbar = document.querySelector('navbar-component');
          if (navbar) {
            // Small delay to ensure authentication state is updated
            setTimeout(() => {
              navbar.render();
              navbar.setupEventListeners();
            }, 100);
          }
        },
        
        // Listen for authentication changes
        onAuthChange: function() {
          this.refreshNavbar();
        }
      };
      
      // Listen for storage changes (login/logout from other tabs)
      window.addEventListener('storage', function(e) {
        if (e.key === 'auth_token' || e.key === 'current_user') {
          window.SchoolApp.refreshNavbar();
        }
      });
      
      // Refresh navbar when DOM is ready
      document.addEventListener('DOMContentLoaded', function() {
        // Small delay to ensure all components are loaded
        setTimeout(() => {
          window.SchoolApp.refreshNavbar();
        }, 100);
      });

      // Signal that SchoolApp is ready
      window.SchoolApp.ready = true;
      
      // Initialize app
      document.addEventListener('DOMContentLoaded', function() {
        // Check authentication status
        if (window.SchoolApp.isAuthenticated()) {
          // User is logged in, update UI accordingly
          const user = window.SchoolApp.getCurrentUser();
          if (user) {
            console.log('Logged in as:', user.name, `(${user.role})`);
          }
        }
      });
    </script>
    
    {% block scripts %}{% endblock %}
  </body>
</html>
